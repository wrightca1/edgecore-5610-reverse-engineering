# switchd Initialization Sequence

**Source**: Reverse engineering of Cumulus Linux 2.5.1
**Date**: 2026-02-15

## Complete Startup Flow

### Phase 1: Pre-init (before main)

1. **Parse command line**
   - `-d` = debug/foreground
   - `-lic /path` = license file

2. **License validation**
   - Read `/etc/cumulus/.license.txt`
   - PGP signature verification (embedded public key)
   - Expiration check
   - Fail and exit if invalid

### Phase 2: Config Load

3. **Load switchd.conf**
   - `/etc/cumulus/switchd.conf`
   - Logging, options

4. **Load BCM config**
   - Chip defaults: `/usr/share/cumulus/__chip_config/bcm/Trident/sdk.bcm`
   - Platform: `/etc/bcm.d/config.d/01config.bcm`
   - Merged key=value parameters

### Phase 3: BDE / SDK Init

5. **BDE module check**
   - Expect `/dev/linux-user-bde` and `/dev/linux-kernel-bde`
   - Modules loaded by hw_init before switchd

6. **Open BDE device**
   - open("/dev/linux-user-bde")
   - ioctl for init/attach

7. **SDK attach**
   - bcm_attach(unit=0, devid=0xb846, ...)
   - Detects BCM56846

8. **SDK init**
   - bcm_init(unit=0)
   - Loads config from merged .bcm
   - Initializes DMA, interrupts (IRQ 16 on Cumulus kernel 3.2.60)

### Phase 4: SOC Init (rc.soc)

9. **Execute rc.soc**
   - `debug -*` (disable all)
   - `attach *`
   - `0:` (unit 0)
   - Optional: sysfs GPIO for LED reset
   - `init all`
   - `0: rcload /etc/bcm.d/rc.ports_0`
   - `rcload /etc/bcm.d/rc.led`
   - `setreg` (statistics, drop counters)
   - `0: rcload /var/lib/cumulus/rc.datapath_0`

10. **rc.datapath_0**
    - Generated by switchd if missing
    - Datapath pipeline config

### Phase 5: Netlink Setup

11. **Create netlink socket**
    - socket(AF_NETLINK, SOCK_RAW, NETLINK_ROUTE)

12. **Bind**
    - bind(..., RTMGRP_LINK | RTMGRP_IPV4_ROUTE | RTMGRP_IPV4_IFADDR | RTMGRP_NEIGH)

13. **Optional: Control socket**
    - /var/run/switchd.socket (for bcmsh)

### Phase 6: Ready

14. **Create ready flag**
    - touch /var/run/switchd.ready

15. **Daemonize** (if not -d)
    - fork, close stdio, write PID file

### Phase 7: Main Loop

16. **Event loop**
    - poll/select on netlink fd
    - recvmsg netlink
    - Dispatch by nlmsg_type
    - Handle RTM_NEWROUTE, RTM_NEWLINK, RTM_NEWNEIGH, etc.

## Boot Order (from init)

1. hw_init (S09) - Load BDE modules, platform init
2. switchd (S10) - This daemon
3. networking - Interface config
4. portwd, acltool, etc.

## Timing

- **Cumulus**: ~12 seconds from start to ready (from switchd.log)
- Bottlenecks: rc.soc execution, datapath load, port init

## Error Handling

- License fail -> exit 1
- BDE open fail -> exit
- bcm_init fail -> exit (e.g. IRQ mismatch on wrong kernel)
- Netlink bind fail -> exit

## References

- [architecture-diagrams.md](architecture-diagrams.md)
- [bcm-config-format.md](bcm-config-format.md)
- [GHIDRA_REGISTER_TABLE_ANALYSIS.md](GHIDRA_REGISTER_TABLE_ANALYSIS.md) - Ghidra found config paths (`/config/route/table`, `/config/arp/drop_during_failed_state`, `/config/coalesce/offset`) loaded in Phase 2 (Config Load) via `FUN_10005ecc`
- [CUMULUS_REVERSE_ENGINEERING_FINDINGS.md](../../CUMULUS_REVERSE_ENGINEERING_FINDINGS.md)
